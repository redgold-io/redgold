use redgold_schema::helpers::easy_json::{json_from, EasyJson};
use redgold_schema::proto_serde::ProtoHashable;
use redgold_schema::structs::{ErrorInfo, Transaction};
use std::hash::Hash;


// Use for future debugging, strange disagreement on genesis.
#[ignore]
#[tokio::test]
async fn test_genesis_issue() {
    let data = r#"
    {"code":16,"description":"","description_extended":"","message":"Missing pow proof option empty","details":[{"detail_name":"transaction","detail":"{\"outputs\":[{\"address\":{\"address\":{\"value\":\"9dd9790a8d75eb17555d091ffe7ff5e77a6a5b7ca7a0993abb0d80476aa7fe18\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":9990000000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"33150611bcbaf033e7ccb2cd90a05432ddc8c3a9cf1ebd8744f3fa93849aa055\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":100000000000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"1cb5cee74fcbaf6c381e146b9677640801f26b20fee8b78307af3a09915dc3dd\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":100000000000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"304c0a4e52fc4c4425b8edb7fdeb016fbd74e65dabdeb2b2d472ebb311638d88\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":100000000000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"dc60094db8f18f7e408af71d7d1c574397b3d04e05bf7dc6b1c171193cda1c67\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":20000000000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"6765bf4a6a35845f89d489b9c06226a9f1e1a69a16a3d00ebe6402cd834cb6da\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":5000000000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"61fce745ec2041557d210834a8a23d754b182842ea41d1c53e95bd07a23b693f\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":5000000000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"337f2398775b729d5178ff2ed7ce163736e0f343a66d11987b397fae456b8f8e\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":5000000000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"03935fad58b99aa2d2678806e2d0f36df188419e73859ec50d9a0e0c00b87cdb\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":5000000000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"15559790fd1235640c80421e55422cd91f16c3bd70bcf6e05faab5afe4114aea\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":650000000000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"1e1d1b7e8db6ec8ffeac5c2dcb0e87bc102c56e149eae092f3339e695527a496\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":1000000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"462061412b939a77c11d38a8f8caa0d9ac0e49fe7b9306b0420f5f8a8ad0f4dd\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"a0efbdfba65821cb48ae47340eb04194cf99abe171e8b3f35803f3d2445715da\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"6c6e834c48b79a38e6a26ab453ea2c3fa51397a09ac8a5c19360d5c3eb44b44f\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"46ac061efa7052d3e5bc20be65758ce95f2e94c225818320810d220b59a95368\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"b770731641abeaccbcc8704603ea81ebdfbb058fdd1c2d3752065d17e65ab088\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"38ebc9323a24500a0020691fd6380599e643b0e6e062c570713760c1832745ab\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"7d9e2789cf41930eaa3903b51825e985c74ea7d5fdb52fb4d2bb8296f04f3496\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"9ca19acf987442630dbc300edc9135ace64e87badc318f2f33819b6e243e8a88\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"75d87e3eb2236d52738ac9759459adc713bf9f8fc89c27f7a3bdbe746cabd6b6\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"9ab39cd35d9039e09fce69ef624863c9a8f4b3f271e45330afccc8c4e18cdaa5\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"ef01988089a4bd7c4537e6316f4b7e95c71d877b41fd841ead638661075d527a\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"bbf014d508ac9aef13360b06162a527a2f845eba31adf9a74edd7d445b48bc24\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"1e1d1b7e8db6ec8ffeac5c2dcb0e87bc102c56e149eae092f3339e695527a496\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"0c4cece82226d28728da4910b72af72b42e108ce72e7511222a935a518dea13d\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"f4cd5fe81076174cd74906cdd9bd94cd57e91a2c3a2d25261445664b96927e4b\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"08fec475a7aa019de1dd300e6e2a450a8b3df308611ec240bfafc7da9e70f86c\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"1e1d1b7e8db6ec8ffeac5c2dcb0e87bc102c56e149eae092f3339e695527a496\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}},{\"address\":{\"address\":{\"value\":\"0c4cece82226d28728da4910b72af72b42e108ce72e7511222a935a518dea13d\"},\"currency\":0},\"data\":{\"amount\":{\"amount\":500000000,\"string_amount\":null},\"standard_response\":null}}],\"struct_metadata\":{\"time\":1712949364925,\"hash\":{\"bytes\":{\"value\":\"4d3cfcd7d62fd7d5fb13c641cfec10f517f8bab3de13e2d511fd34c0d3e01468\"}},\"signable_hash\":{\"bytes\":{\"value\":\"4d3cfcd7d62fd7d5fb13c641cfec10f517f8bab3de13e2d511fd34c0d3e01468\"}}},\"options\":{\"network_type\":2}}"},{"detail_name":"public_key_origin","detail":"{\"bytes\":{\"value\":\"031b3b7c2c3ccf56994f684743128b444f302e450f9dd2a384424234f7fb0e71a2\"}}"},{"detail_name":"origin_ip","detail":"null"},{"detail_name":"transaction_hash","detail":"0a220a204d3cfcd7d62fd7d5fb13c641cfec10f517f8bab3de13e2d511fd34c0d3e01468"},{"detail_name":"genesis?","detail":"{\"bytes\":{\"value\":\"903e432620d42e591aafad63f64fc3ca992dd738a26b70813ec65cf0c856d2b6\"}}"}],"retriable":false,"stacktrace":" 0: redgold_schema::error_msg\n 1: redgold_schema::error_message\n 2: <core::option::Option<T> as redgold_schema::SafeOption<T>>::safe_get_msg\n 3: <redgold_schema::structs::Transaction as redgold_schema::pow::TransactionPowValidate>::pow_validate\n 4: <redgold_schema::structs::Transaction as redgold_schema::tx_schema_validate::SchemaValidationSupport>::validate_schema\n 5: <redgold_schema::structs::Transaction as redgold_keys::tx_proof_validate::TransactionProofValidator>::validate_keys\n 6: <redgold_schema::structs::Transaction as redgold::core::transact::tx_validate::TransactionValidator>::validate\n 7: <redgold::core::mempool::Mempool as redgold::core::stream_handlers::IntervalFold>::interval_fold::{{closure}}\n 8: <core::pin::Pin<P> as core::future::future::Future>::poll\n 9: redgold::core::stream_handlers::run_interval_inner::{{closure}}\n 10: tokio::runtime::task::raw::poll\n 11: tokio::runtime::scheduler::multi_thread::worker::Context::run_task\n 12: tokio::runtime::context::scoped::Scoped<T>::set\n 13: std::thread::local::LocalKey<T>::with\n 14: tokio::runtime::context::runtime::enter_runtime\n 15: tokio::runtime::scheduler::multi_thread::worker::run\n 16: <tokio::runtime::blocking::task::BlockingTask<T> as core::future::future::Future>::poll\n 17: tokio::runtime::task::core::Core<T,S>::poll\n 18: tokio::runtime::task::harness::poll_future\n 19: tokio::runtime::task::harness::Harness<T,S>::poll_inner\n 20: tokio::runtime::task::harness::Harness<T,S>::poll\n 21: tokio::runtime::task::raw::poll\n 22: std::sys_common::backtrace::__rust_begin_short_backtrace\n 23: core::ops::function::FnOnce::call_once{{vtable.shim}}\n 24: std::sys::pal::unix::thread::Thread::new::thread_start\n 25: <unknown>\n 26: __clone\n","lib_message":"","abort":false,"skip_logging":false,"internal_log_level":null}
    "#;

    let js = json_from::<ErrorInfo>(data).expect("Failed to parse json");

    let tx = js.details.iter()
        .filter(|x| x.detail_name == "transaction".to_string()).next().expect("Transaction not found").detail.clone();
    let tx = json_from::<Transaction>(&*tx).expect("Failed to parse json");
    println!("tx: {}", tx.json_or());
    println!("tx: {}", tx.calculate_hash().json_or());

    // claimed genesis from above 903e432620d42e591aafad63f64fc3ca992dd738a26b70813ec65cf0c856d2b6

    let api_genesis = r#"{"outputs":[{"address":{"address":{"value":"9dd9790a8d75eb17555d091ffe7ff5e77a6a5b7ca7a0993abb0d80476aa7fe18"},"currency":0},"data":{"amount":{"amount":9990000000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"33150611bcbaf033e7ccb2cd90a05432ddc8c3a9cf1ebd8744f3fa93849aa055"},"currency":0},"data":{"amount":{"amount":100000000000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"1cb5cee74fcbaf6c381e146b9677640801f26b20fee8b78307af3a09915dc3dd"},"currency":0},"data":{"amount":{"amount":100000000000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"304c0a4e52fc4c4425b8edb7fdeb016fbd74e65dabdeb2b2d472ebb311638d88"},"currency":0},"data":{"amount":{"amount":100000000000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"dc60094db8f18f7e408af71d7d1c574397b3d04e05bf7dc6b1c171193cda1c67"},"currency":0},"data":{"amount":{"amount":20000000000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"6765bf4a6a35845f89d489b9c06226a9f1e1a69a16a3d00ebe6402cd834cb6da"},"currency":0},"data":{"amount":{"amount":5000000000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"61fce745ec2041557d210834a8a23d754b182842ea41d1c53e95bd07a23b693f"},"currency":0},"data":{"amount":{"amount":5000000000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"337f2398775b729d5178ff2ed7ce163736e0f343a66d11987b397fae456b8f8e"},"currency":0},"data":{"amount":{"amount":5000000000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"03935fad58b99aa2d2678806e2d0f36df188419e73859ec50d9a0e0c00b87cdb"},"currency":0},"data":{"amount":{"amount":5000000000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"15559790fd1235640c80421e55422cd91f16c3bd70bcf6e05faab5afe4114aea"},"currency":0},"data":{"amount":{"amount":650000000000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"462061412b939a77c11d38a8f8caa0d9ac0e49fe7b9306b0420f5f8a8ad0f4dd"},"currency":0},"data":{"amount":{"amount":1000000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"462061412b939a77c11d38a8f8caa0d9ac0e49fe7b9306b0420f5f8a8ad0f4dd"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"a0efbdfba65821cb48ae47340eb04194cf99abe171e8b3f35803f3d2445715da"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"6c6e834c48b79a38e6a26ab453ea2c3fa51397a09ac8a5c19360d5c3eb44b44f"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"46ac061efa7052d3e5bc20be65758ce95f2e94c225818320810d220b59a95368"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"b770731641abeaccbcc8704603ea81ebdfbb058fdd1c2d3752065d17e65ab088"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"38ebc9323a24500a0020691fd6380599e643b0e6e062c570713760c1832745ab"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"7d9e2789cf41930eaa3903b51825e985c74ea7d5fdb52fb4d2bb8296f04f3496"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"9ca19acf987442630dbc300edc9135ace64e87badc318f2f33819b6e243e8a88"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"75d87e3eb2236d52738ac9759459adc713bf9f8fc89c27f7a3bdbe746cabd6b6"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"9ab39cd35d9039e09fce69ef624863c9a8f4b3f271e45330afccc8c4e18cdaa5"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"ef01988089a4bd7c4537e6316f4b7e95c71d877b41fd841ead638661075d527a"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"bbf014d508ac9aef13360b06162a527a2f845eba31adf9a74edd7d445b48bc24"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"1e1d1b7e8db6ec8ffeac5c2dcb0e87bc102c56e149eae092f3339e695527a496"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"0c4cece82226d28728da4910b72af72b42e108ce72e7511222a935a518dea13d"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"f4cd5fe81076174cd74906cdd9bd94cd57e91a2c3a2d25261445664b96927e4b"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"08fec475a7aa019de1dd300e6e2a450a8b3df308611ec240bfafc7da9e70f86c"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"462061412b939a77c11d38a8f8caa0d9ac0e49fe7b9306b0420f5f8a8ad0f4dd"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}},{"address":{"address":{"value":"a0efbdfba65821cb48ae47340eb04194cf99abe171e8b3f35803f3d2445715da"},"currency":0},"data":{"amount":{"amount":500000000,"string_amount":null},"standard_response":null}}],"struct_metadata":{"time":1712949364925,"hash":{"bytes":{"value":"903e432620d42e591aafad63f64fc3ca992dd738a26b70813ec65cf0c856d2b6"}},"signable_hash":{"bytes":{"value":"903e432620d42e591aafad63f64fc3ca992dd738a26b70813ec65cf0c856d2b6"}}},"options":{"network_type":2}}"#;
    let tx2 = json_from::<Transaction>(api_genesis).expect("Failed to parse json");
    println!("tx2: {}", tx2.json_or());
    println!("tx2: {}", tx2.calculate_hash().json_or());
}